<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SaporAI ‚Äì Ricette gourmet</title>
  
  <!-- Inter + Material Symbols -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet" />

  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
  <script type="importmap">
    {
      "imports": {
        "@material/web/": "https://esm.run/@material/web/"
      }
    }
  </script>
  <script type="module">
    import '@material/web/all.js';
    import {styles as typescaleStyles} from '@material/web/typography/md-typescale-styles.js';

    document.adoptedStyleSheets.push(typescaleStyles.styleSheet);
  </script>

  <style>
    /* =====================================================
       SAPORAI ‚Äî PALETTE MODERNA (Food-friendly, M3-like)
       -----------------------------------------------------
       Primary (Coral):   #FF6B6B
       Secondary (Sage):  #48B38F
       Tertiary (Grape):  #7C5CFF
       Surface (Cream):   #FFF8F1
       Surface-Card:      #FFFFFF
       Text (Ink):        #0F172A
       Muted:             #64748B
       Chip BG:           #F3F4F6
    ====================================================== */
    :root {
      --brand-primary: #FF6B6B; /* Coral */
      --brand-on-primary: #FFFFFF;
      --brand-secondary: #48B38F; /* Sage */
      --brand-tertiary: #7C5CFF; /* Grape */
      --brand-surface: #FFF8F1; /* Cream */
      --brand-surface-card: #FFFFFF;
      --brand-ink: #0F172A; /* Text */
      --brand-muted: #64748B;
      --brand-chip: #F3F4F6;
      --radius: 16px;
      --shadow: 0 10px 30px rgba(16,24,40,.08);

      /* Mappa su token Material 3 per coerenza */
      --md-sys-color-primary: var(--brand-primary);
      --md-sys-color-on-primary: var(--brand-on-primary);
      --md-sys-color-secondary: var(--brand-secondary);
      --md-sys-color-surface: var(--brand-surface);
      --md-sys-color-on-surface: var(--brand-ink);
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0;
      font-family: Inter, system-ui, -apple-system, Segoe UI, Arial, sans-serif;
      color: var(--brand-ink);
      background: radial-gradient(1200px 600px at -10% -20%, rgba(255,107,107,.12) 0%, rgba(255,107,107,0) 60%),
                  radial-gradient(1000px 700px at 110% 0%, rgba(72,179,143,.08) 0%, rgba(72,179,143,0) 60%),
                  var(--brand-surface);
    }
    /* Top App Bar */
    header.appbar {
      position: sticky; top: 0; z-index: 10;
      display: flex; align-items: center; gap: 12px;
      padding: 12px 16px;
      backdrop-filter: saturate(1.1) blur(6px);
      background: color-mix(in oklab, #fff 85%, transparent);
      border-bottom: 1px solid color-mix(in oklab, #000 6%, transparent);
    }
    header .title { font-weight: 700; letter-spacing: .2px; display:flex; align-items:center; gap:8px; }
    header .title .logo-dot { width:10px; height:10px; border-radius:999px; background: var(--brand-primary); box-shadow: 0 0 0 6px color-mix(in oklab, var(--brand-primary) 30%, transparent); }

    /* Layout */
    main { max-width: 1100px; margin: 0 auto; padding: 16px; }
    .searchbar { display: grid; grid-template-columns: 1fr auto; gap: 12px; align-items: end; }
    .quick-filters { margin-top: 10px; display: flex; flex-wrap: wrap; gap: 8px; }

    /* Results list */
    .results { margin-top: 18px; display: grid; gap: 14px; }
    .card { background: var(--brand-surface-card); border: 1px solid #eee; border-radius: var(--radius); padding: 14px 14px; display: grid; gap: 10px; cursor: pointer; transition: box-shadow .2s ease, transform .06s ease, border-color .2s ease; }
    .card:hover { box-shadow: var(--shadow); border-color: color-mix(in oklab, var(--brand-primary) 22%, #eee); transform: translateY(-1px); }
    .card:active { transform: translateY(1px); }
    .card .title { font-weight: 700; font-size: 1.06rem; }
    .meta { display: flex; flex-wrap: wrap; gap: 8px; font-size: .92rem; color: var(--brand-muted); align-items: center; }
    .meta .chip { background: var(--brand-chip); border-radius: 999px; padding: 4px 10px; }
    .score { margin-left: auto; display: inline-flex; align-items: center; gap: 6px; color:#065F46; font-weight:600; }
    .material-symbols-outlined { font-variation-settings: 'FILL' 0, 'wght' 500, 'GRAD' 0, 'opsz' 24; vertical-align: middle; }

    /* Thumb (lista) */
    .card-list { grid-template-columns: 128px 1fr; align-items: center; }
    .thumb { width: 100%; aspect-ratio: 16/10; border-radius: 12px; object-fit: cover; background: var(--brand-chip); }
    .thumb.placeholder { display:flex; align-items:center; justify-content:center; font-size: 28px; }

    /* Detail view */
    .detail { display: none; }
    .detail.active { display: grid; gap: 18px; }
    .back-row { display: flex; align-items: center; gap: 10px; }
    .section { background: var(--brand-surface-card); border: 1px solid #eee; border-radius: var(--radius); padding: 16px; }
    .section h3 { margin: 0 0 10px; font-size: 1rem; letter-spacing: .2px; }
    .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .chips { display: flex; flex-wrap: wrap; gap: 8px; }
    .ingredients li { margin: .25rem 0; }
    .steps li { margin: .5rem 0; }
    .muted { color: var(--brand-muted); }

    /* Hero image nel dettaglio */
    .hero-image { border-radius: 20px; overflow: hidden; }
    .hero-image .thumb { width: 100%; aspect-ratio: 16/9; border-radius: 20px; }
    .hero-image .thumb.placeholder { font-size: 64px; }

    /* Helpers */
    .hidden { display: none !important; }

    /* Responsive */
    @media (max-width: 840px) {
      .grid-2 { grid-template-columns: 1fr; }
      .searchbar { grid-template-columns: 1fr; }
      .card-list { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <header class="appbar">
    <md-icon-button id="backBtn" class="hidden" title="Indietro"><span class="material-symbols-outlined">arrow_back</span></md-icon-button>
    <div class="title"><span class="logo-dot"></span> SaporAI</div>
  </header>

  <main>
    <!-- SEARCH VIEW -->
    <section id="searchView">
      <div class="searchbar">
        <!-- Campo di ricerca NLP -->
        <md-outlined-text-field
          id="q"
          label="Descrivi cosa vuoi cucinare‚Ä¶"
          placeholder="Es. pasta vegana con broccoli pronta in meno di 30 minuti"
          supporting-text="Ricerca in linguaggio naturale (NLP)"
          class="full"
          style="width:100%"
        >
          <span slot="leading-icon" class="material-symbols-outlined">search</span>
        </md-outlined-text-field>
        <md-filled-button id="searchBtn" aria-label="Cerca">Cerca</md-filled-button>
      </div>
      
      <!-- Filtri rapidi (aggiungono termini alla query) -->
      <div class="quick-filters" aria-label="Filtri rapidi">
        <md-filter-chip data-token="vegetariano" label="Vegetariano"></md-filter-chip>
        <md-filter-chip data-token="vegano" label="Vegano"></md-filter-chip>
        <md-filter-chip data-token="senza glutine" label="Senza glutine"></md-filter-chip>
        <md-filter-chip data-token="< 30 min" label="‚â§ 30 min"></md-filter-chip>
        <md-filter-chip data-token="italiana" label="Italiana"></md-filter-chip>
        <md-filter-chip data-token="piccante" label="Piccante"></md-filter-chip>
      </div>

      <!-- Stato caricamento -->
      <div id="loading" class="hidden" style="display:flex;align-items:center;gap:10px;margin-top:14px;">
        <md-circular-progress indeterminate></md-circular-progress>
        <span>Cerco le ricette pi√π pertinenti‚Ä¶</span>
      </div>

      <!-- Risultati -->
      <div id="results" class="results" aria-live="polite"></div>
    </section>

    <!-- DETAIL VIEW -->
    <section id="detailView" class="detail" aria-live="polite"></section>
  </main>

  <script>
    /*************************************************
     * SaporAI ‚Äì MVP Ricette NLP ‚Äì Vanilla JS + M3   *
     * ------------------------------------------------
     * - Ricerca NLP via API REST
     * - Lista risultati con thumbnail/immagini
     * - Pagina dettaglio con hero image e specifiche
     * - Palette moderna + micro-animazioni
     *************************************************/

    /** CONFIGURAZIONE */
    const CONFIG = {
      DEMO_MODE: false,
      API_BASE_URL: "http://127.0.0.1:8000",
      ENDPOINTS: { SEARCH: "/search", DETAIL: "/ricette/" },
    };

    /** API Client minimale */
    const Api = {
      async search(q) {
        if (CONFIG.DEMO_MODE) return Demo.search(q);
        const url = `${CONFIG.API_BASE_URL}${CONFIG.ENDPOINTS.SEARCH}?query=${encodeURIComponent(q)}`;
        const res = await fetch(url, { headers: { "Accept": "application/json" } });
        if (!res.ok) throw new Error("Errore risposta API search");
        return res.json();
      },
      async getById(id) {
        if (CONFIG.DEMO_MODE) return Demo.getById(id);
        const url = `${CONFIG.API_BASE_URL}${CONFIG.ENDPOINTS.DETAIL}${encodeURIComponent(id)}`;
        const res = await fetch(url, { headers: { "Accept": "application/json" } });
        if (!res.ok) throw new Error("Errore risposta API dettaglio");
        return res.json();
      }
    };

    /** DATI DI ESEMPIO con image_url opzionale */
    const Demo = (() => {
      const id = (n) => `demo-${n}`;
      const RECIPES = [
        {
          _id: id(1),
          category: ["Primo"],
          chef_advise: "Usa tuorli a temperatura ambiente per una crema pi√π setosa.",
          cooking_time: 10,
          cuisine_type: "Italiana",
          description: "Classica pasta alla Carbonara cremosa senza panna.",
          diet: "onnivoro",
          embedding: [0.12, 0.04, -0.11, 0.33],
          ingredients: [
            { name: "Spaghetti", qt: 320, um: "g" },
            { name: "Guanciale", qt: 120, um: "g" },
            { name: "Tuorli", qt: 6, um: "pz" },
            { name: "Pecorino romano", qt: 80, um: "g" },
            { name: "Pepe nero", qt: 2, um: "g" },
            { name: "Sale", qt: 1, um: "q.b." },
          ],
          language: "it",
          nutritional_info: ["Calorie: 420 kcal/porzione", "Proteine: 18 g", "Carboidrati: 55 g", "Grassi: 12 g"],
          preparation_time: 5,
          recipe_step: [
            "Rosola il guanciale a fiamma media finch√© croccante.",
            "Sbatti i tuorli con pecorino e pepe.",
            "Cuoci la pasta al dente, conserva acqua di cottura.",
            "Manteca fuori dal fuoco con crema d'uovo, poca acqua e guanciale.",
          ],
          ricetta_audio: "https://cdn.example.com/audio/carbonara.mp3",
          ricetta_caption: "Pasta alla Carbonara ‚Äì versione tradizionale romana",
          shortcode: "CARBO",
          tags: ["classico", "cremoso"],
          technique: "Mantecatura",
          title: "Pasta alla Carbonara",
          score: 0.91,
          image_url: "https://picsum.photos/seed/carbonara/960/640"
        },
        {
          _id: id(2),
          category: ["Primo"],
          chef_advise: "Tosta bene il riso e sfuma generosamente per un risotto cremoso.",
          cooking_time: 18,
          cuisine_type: "Italiana",
          description: "Risotto ai funghi porcini, cremoso e profumato.",
          diet: "vegetariano",
          embedding: [0.08, -0.01, 0.15, 0.29],
          ingredients: [
            { name: "Riso Carnaroli", qt: 320, um: "g" },
            { name: "Porcini", qt: 200, um: "g" },
            { name: "Brodo vegetale", qt: 1, um: "l" },
            { name: "Burro", qt: 40, um: "g" },
            { name: "Parmigiano", qt: 50, um: "g" },
            { name: "Scalogno", qt: 1, um: "pz" },
          ],
          language: "it",
          nutritional_info: ["Calorie: 380 kcal/porzione", "Proteine: 10 g", "Carboidrati: 60 g", "Grassi: 9 g"],
          preparation_time: 10,
          recipe_step: [
            "Soffriggi lo scalogno tritato.",
            "Tosta il riso, sfuma con vino bianco.",
            "Aggiungi brodo poco alla volta e i funghi.",
            "Manteca con burro e parmigiano.",
          ],
          ricetta_audio: "https://cdn.example.com/audio/risotto.mp3",
          ricetta_caption: "Risotto ai funghi ‚Äì comfort food autunnale",
          shortcode: "RIS-FUN",
          tags: ["senza glutine", "cremoso"],
          technique: "Risottatura",
          title: "Risotto ai funghi",
          score: 0.84,
          image_url: "https://picsum.photos/seed/risotto/960/640"
        },
        {
          _id: id(3),
          category: ["Primo"],
          chef_advise: "Aggiungi l'acqua di cottura a filo per emulsionare l'olio.",
          cooking_time: 8,
          cuisine_type: "Italiana",
          description: "Spaghetti aglio, olio e peperoncino: semplici e veloci.",
          diet: "vegano",
          embedding: [0.02, 0.22, -0.02, 0.11],
          ingredients: [
            { name: "Spaghetti", qt: 320, um: "g" },
            { name: "Aglio", qt: 3, um: "spicchi" },
            { name: "Olio EVO", qt: 60, um: "ml" },
            { name: "Peperoncino", qt: 1, um: "pz" },
            { name: "Prezzemolo", qt: 1, um: "ciuffo" },
            { name: "Sale", qt: 1, um: "q.b." },
          ],
          language: "it",
          nutritional_info: ["Calorie: 360 kcal/porzione", "Proteine: 9 g", "Carboidrati: 62 g", "Grassi: 9 g"],
          preparation_time: 5,
          recipe_step: [
            "Soffriggi aglio e peperoncino nell'olio.",
            "Cuoci gli spaghetti e scolali al dente.",
            "Salta in padella emulsionando con acqua di cottura.",
            "Completa con prezzemolo tritato.",
          ],
          ricetta_audio: "https://cdn.example.com/audio/aglioolio.mp3",
          ricetta_caption: "Aglio, olio e peperoncino ‚Äì salvacena veloce",
          shortcode: "AOP",
          tags: ["veloce", "economico"],
          technique: "Saltare",
          title: "Spaghetti aglio e olio",
          score: 0.78,
          image_url: "https://picsum.photos/seed/aglioolio/960/640"
        },
      ];

      function rankByQuery(q) {
        const terms = (q||"").toLowerCase().split(/\s+/).filter(Boolean);
        return RECIPES.map(r => {
          let s = r.score ?? 0.5;
          const hay = (
            r.title + " " + r.description + " " + r.diet + " " + r.cuisine_type + " " + r.tags.join(" ")
          ).toLowerCase();
          for (const t of terms) if (hay.includes(t)) s += 0.05;
          return { ...r, score: Math.min(1, Number(s.toFixed(2))) };
        }).sort((a,b) => b.score - a.score);
      }
      return { async search(q){ await sleep(450); return rankByQuery(q); }, async getById(id){ await sleep(250); return RECIPES.find(r=>r._id===id); } };
    })();

    // Utility: delay
    function sleep(ms) { return new Promise(r => setTimeout(r, ms)); }

    // Stato semplice dell'app
    const state = { results: [], lastQuery: "", current: null };

    // Riferimenti DOM
    const $ = sel => document.querySelector(sel);
    const resultsEl = document.querySelector("#results");
    const loadingEl = document.querySelector("#loading");
    const detailView = document.querySelector("#detailView");
    const searchView = document.querySelector("#searchView");
    const qInput = document.querySelector("#q");
    const backBtn = document.querySelector("#backBtn");

    // Router hash ‚Äì #/ricetta/:id oppure root
    window.addEventListener("hashchange", onRouteChange);
    window.addEventListener("DOMContentLoaded", () => { attachEvents(); onRouteChange(); });

    async function onRouteChange() {
      const id = parseRecipeIdFromHash();
      if (id) {
        backBtn.classList.remove("hidden");
        searchView.style.display = "none";
        detailView.classList.add("active");
        renderDetailSkeleton();
        try {
          const recipe = await Api.getById(id);
          if (!recipe) throw new Error("Ricetta non trovata");
          state.current = recipe;
          renderDetail(recipe);
        } catch (err) { renderError(detailView, err); }
      } else {
        backBtn.classList.add("hidden");
        detailView.classList.remove("active");
        searchView.style.display = "block";
        if (!state.results.length) renderEmptyState();
      }
    }

    function parseRecipeIdFromHash() {
      const m = location.hash.match(/^#\/ricetta\/(.+)$/);
      return m ? decodeURIComponent(m[1]) : null;
    }

    function attachEvents() {
      document.querySelector("#searchBtn").addEventListener("click", () => doSearch(qInput.value));
      qInput.addEventListener("keydown", (e) => { if (e.key === "Enter") doSearch(qInput.value); });
      document.querySelectorAll("md-filter-chip[data-token]").forEach(chip => {
        chip.addEventListener("click", () => {
          const token = chip.getAttribute("data-token");
          const val = qInput.value.trim();
          qInput.value = val ? `${val} ${token}` : token;
          qInput.focus();
        });
      });
      backBtn.addEventListener("click", () => { location.hash = ""; });
    }

    async function doSearch(q) {
      const query = (q || "").trim();
      state.lastQuery = query;
      resultsEl.innerHTML = "";
      loadingEl.classList.remove("hidden");
      try {
        const results = await Api.search(query);
        state.results = Array.isArray(results) ? results : [];
        renderResults(state.results);
      } catch (err) { renderError(resultsEl, err); }
      finally { loadingEl.classList.add("hidden"); }
    }

    function renderEmptyState() {
      resultsEl.innerHTML = `
        <div class="section" style="text-align:center">
          <h3>Cerca ricette con SaporAI</h3>
          <p class="muted">Esempi: "dolce vegano senza glutine", "pasta pronta in 20 minuti", "cena piccante con ceci"</p>
        </div>`;
    }

    function renderResults(list) {
      if (!list.length) {
        resultsEl.innerHTML = `<div class="section">Nessun risultato per <strong>${escapeHtml(state.lastQuery)}</strong>.</div>`;
        return;
      }
      const frag = document.createDocumentFragment();
      list.forEach(r => frag.appendChild(renderResultCard(r)));
      resultsEl.innerHTML = "";
      resultsEl.appendChild(frag);
      // animazione entrata
      Array.from(resultsEl.children).forEach((el, i) => {
        el.animate([{opacity:0, transform:'translateY(8px)'},{opacity:1, transform:'translateY(0)'}], {duration:320, delay: i*35, easing:'ease-out'});
      });
    }

    function renderResultCard(r) {
      const el = document.createElement("article");
      el.className = "card card-list";
      el.setAttribute("role", "button");
      el.setAttribute("aria-label", `Apri ${r.title}`);
      el.innerHTML = `
        ${renderThumb(r, 'list')}
        <div>
          <div class="title">${escapeHtml(r.title)}</div>
          <div class="meta">
            <span class="chip"><span class="material-symbols-outlined">timer</span>&nbsp;Prep ${r.preparation_time} min ¬∑ Cott ${r.cooking_time} min</span>
            <span class="chip">${escapeHtml(r.cuisine_type)}</span>
            <span class="chip">${escapeHtml(r.diet)}</span>
            ${(r.tags||[]).slice(0,2).map(t=>`<span class="chip">${escapeHtml(t)}</span>`).join("")}
            <span class="score" title="Attendibilit√†"><span class="material-symbols-outlined">verified</span>${formatScore(r.score)}</span>
          </div>
          <div class="muted">${escapeHtml((r.description||"").slice(0,140))}${r.description && r.description.length>140?"‚Ä¶":""}</div>
        </div>`;
      el.addEventListener("click", () => { location.hash = `#/ricetta/${encodeURIComponent(r._id)}`; });
      return el;
    }

    function renderDetailSkeleton() {
      detailView.innerHTML = `
        <div class="back-row">
          <md-icon-button title="Indietro"><span class="material-symbols-outlined">arrow_back</span></md-icon-button>
          <div class="muted">Caricamento ricetta‚Ä¶</div>
        </div>
        <md-linear-progress indeterminate></md-linear-progress>`;
      detailView.querySelector("md-icon-button")?.addEventListener("click", () => history.back());
    }

    function renderDetail(r) {
      detailView.innerHTML = `
        <div class="back-row">
          <md-icon-button title="Indietro"><span class="material-symbols-outlined">arrow_back</span></md-icon-button>
          <h2 style="margin:0">${escapeHtml(r.title)}</h2>
        </div>
        <div class="hero-image">${renderThumb(r, 'hero')}</div>

        <div class="grid-2">
          <div class="section">
            <h3>Descrizione</h3>
            <p>${escapeHtml(r.description || "")}</p>
            <div class="chips" style="margin-top:8px">
              ${chip("Categoria", (r.category||[]).join(", "))}
              ${chip("Cucina", r.cuisine_type)}
              ${chip("Dieta", r.diet)}
              ${chip("Tecnica", r.technique)}
              ${(r.tags||[]).map(t=>chip("Tag", t)).join("")}
            </div>
          </div>

          <div class="section">
            <h3>Tempi</h3>
            <p><span class="material-symbols-outlined">schedule</span> Preparazione: <strong>${r.preparation_time} min</strong></p>
            <p><span class="material-symbols-outlined">timer</span> Cottura: <strong>${r.cooking_time} min</strong></p>
            ${typeof r.score === 'number' ? `<p class="muted"><span class="material-symbols-outlined">verified</span> Attendibilit√†: <strong>${formatScore(r.score)}</strong></p>` : ''}
          </div>
        </div>

        <div class="grid-2">
          <div class="section">
            <h3>Ingredienti</h3>
            <ul class="ingredients">
              ${(r.ingredients||[]).map(it => `<li>${escapeHtml(it.name)} ‚Äî <strong>${formatQty(it.qt)} ${escapeHtml(it.um)}</strong></li>`).join("")}
            </ul>
          </div>
          <div class="section">
            <h3>Procedimento</h3>
            <ol class="steps">${(r.recipe_step||[]).map(s => `<li>${escapeHtml(s)}</li>`).join("")}</ol>
          </div>
        </div>

        <div class="grid-2">
          <div class="section">
            <h3>Consiglio dello chef</h3>
            <p>${escapeHtml(r.chef_advise || "-")}</p>
          </div>
          <div class="section">
            <h3>Informazioni nutrizionali</h3>
            <ul>${(r.nutritional_info||[]).map(s => `<li>${escapeHtml(s)}</li>`).join("")}</ul>
          </div>
        </div>

        <div class="grid-2">
          <div class="section">
            <h3>Ascolta la ricetta</h3>
            ${r.ricetta_audio ? `<audio controls src="${escapeAttr(r.ricetta_audio)}" style="width:100%"></audio>` : '<p class="muted">Audio non disponibile</p>'}
            ${r.ricetta_caption ? `<p class="muted" style="margin-top:6px">${escapeHtml(r.ricetta_caption)}</p>` : ''}
          </div>
          <div class="section">
            <h3>Condivisione</h3>
            <p>Shortcode: <code>${escapeHtml(r.shortcode || r._id)}</code></p>
            <md-outlined-button id="shareBtn"><span class="material-symbols-outlined">share</span>&nbsp;Copia link</md-outlined-button>
          </div>
        </div>`;

      detailView.querySelector("md-icon-button")?.addEventListener("click", () => history.back());
      detailView.querySelector("#shareBtn")?.addEventListener("click", () => copyLink(r._id));

      // animate hero
      detailView.querySelector('.hero-image')?.animate([
        {opacity:0, transform:'scale(.98)'}, {opacity:1, transform:'scale(1)'}
      ], {duration:380, easing:'ease-out'});
    }

    /* Helpers di rendering */
    function chip(label, value) { if (!value) return ""; return `<span class="chip" title="${escapeAttr(label)}">${escapeHtml(value)}</span>`; }
    function formatQty(q) { return (typeof q === 'number' && Number.isFinite(q)) ? (Number.isInteger(q) ? q : q.toLocaleString('it-IT')) : q; }
    function escapeHtml(s="") { return s.replace(/[&<>\"]/g, c => ({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;"}[c])); }
    function escapeAttr(s="") { return escapeHtml(String(s)).replace(/'/g, "&#39;"); }
    function formatScore(s) { if (typeof s !== "number") return ""; return Math.round(s * 100) + "%"; }

    function renderThumb(r, variant) {
      const url = r.image_url || r.image || null;
      if (url) return `<img class="thumb" src="${escapeAttr(url)}" alt="${escapeAttr(r.title)}">`;
      const g = gradientFromString(r.title || "");
      const emoji = pickEmoji(r);
      const font = variant === 'hero' ? '64px' : '28px';
      return `<div class="thumb placeholder" style="background:${g}"><div style="font-size:${font}">${emoji}</div></div>`;
    }

    function pickEmoji(r){
      // Semplice euristica per rendere la UI pi√π calda
      const t = (r.title||"").toLowerCase();
      if (t.includes('pasta') || t.includes('spaghetti')) return 'üçù';
      if (t.includes('risotto') || t.includes('riso')) return 'üçö';
      if (t.includes('dolce') || t.includes('dessert')) return 'üç∞';
      if (t.includes('zuppa') || t.includes('soup')) return 'ü•£';
      return 'üçΩÔ∏è';
    }

    function gradientFromString(s){
      const palettes = [
        ['#FF6B6B','#FFD3B6'],
        ['#48B38F','#D1F5EA'],
        ['#7C5CFF','#E6E1FF'],
        ['#F59E0B','#FFE6B3'],
        ['#06B6D4','#CFFAFE']
      ];
      let hash = 0; for (let i=0;i<s.length;i++) hash = s.charCodeAt(i) + ((hash<<5)-hash);
      const idx = Math.abs(hash) % palettes.length;
      const [c1,c2] = palettes[idx];
      return `linear-gradient(135deg, ${c1}, ${c2})`;
    }

    async function copyLink(id) {
      const url = `${location.origin}${location.pathname}#/ricetta/${encodeURIComponent(id)}`;
      try { await navigator.clipboard.writeText(url); alert("Link copiato negli appunti!\n" + url); }
      catch { prompt("Copia manualmente il link:", url); }
    }

    function renderError(target, err) {
      target.innerHTML = `<div class="section">‚ö†Ô∏è ${escapeHtml(err.message||'Errore inatteso')}</div>`;
    }
  </script>
</body>
</html>