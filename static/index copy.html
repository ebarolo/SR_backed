<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Smart RECIPE</title>
  
  <!-- Roboto + Material Symbols -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet" />

  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
  <script type="importmap">
    {
      "imports": {
        "@material/web/": "https://esm.run/@material/web/"
      }
    }
  </script>
  <script type="module">
    import '@material/web/all.js';
    import {styles as typescaleStyles} from '@material/web/typography/md-typescale-styles.js';

    document.adoptedStyleSheets.push(typescaleStyles.styleSheet);
  </script>

  <style>
    :root {
      /* Palette Material 3 – calda/food-friendly */
      --md-sys-color-primary: #F57C00;  /* arancio */
      --md-sys-color-on-primary: #FFFFFF;
      --md-sys-color-secondary: #795548; /* brown */
      --md-sys-color-surface: #FFFDF9;
      --md-sys-color-on-surface: #1B1B1B;
      --radius: 16px;
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0;
      font-family: Roboto, system-ui, -apple-system, Segoe UI, Arial, sans-serif;
      color: var(--md-sys-color-on-surface);
      background: var(--md-sys-color-surface);
    }
    /* Top App Bar */
    header.appbar {
      position: sticky;
      top: 0; z-index: 10;
      display: flex; align-items: center; gap: 12px;
      padding: 10px 16px;
      background: white;
      border-bottom: 1px solid #eee;
    }
    header .title { font-weight: 700; letter-spacing: .2px; }
    header .title .dot { color: var(--md-sys-color-primary); }

    /* Layout */
    main {
      max-width: 1100px; margin: 0 auto; padding: 16px;
    }
    .searchbar { display: grid; grid-template-columns: 1fr auto; gap: 12px; align-items: end; }
    .quick-filters { margin-top: 10px; display: flex; flex-wrap: wrap; gap: 8px; }

    /* Results list */
    .results { margin-top: 18px; display: grid; gap: 12px; }
    .card { background: white; border: 1px solid #eee; border-radius: var(--radius); padding: 14px 16px; display: grid; gap: 6px; cursor: pointer; transition: box-shadow .2s ease, transform .04s ease; }
    .card:hover { box-shadow: 0 8px 24px rgba(0,0,0,.06); }
    .card:active { transform: translateY(1px); }
    .card .title { font-weight: 600; font-size: 1.05rem; }
    .meta { display: flex; flex-wrap: wrap; gap: 8px; font-size: .9rem; color: #5f6368; align-items: center; }
    .meta .chip { background: #F7EFE8; border-radius: 999px; padding: 4px 10px; }
    .score { margin-left: auto; display: inline-flex; align-items: center; gap: 4px; }
    .material-symbols-outlined { font-variation-settings: 'FILL' 0, 'wght' 500, 'GRAD' 0, 'opsz' 24; vertical-align: middle; }

    /* Detail view */
    .detail { display: none; }
    .detail.active { display: grid; gap: 18px; }
    .back-row { display: flex; align-items: center; gap: 10px; }
    .section { background: white; border: 1px solid #eee; border-radius: var(--radius); padding: 16px; }
    .section h3 { margin: 0 0 10px; font-size: 1rem; letter-spacing: .2px; }
    .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .chips { display: flex; flex-wrap: wrap; gap: 8px; }
    .ingredients li { margin: .25rem 0; }
    .steps li { margin: .5rem 0; }
    .muted { color: #616161; }

    /* Helpers */
    .hidden { display: none !important; }

    /* Responsive */
    @media (max-width: 840px) {
      .grid-2 { grid-template-columns: 1fr; }
      .searchbar { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <header class="appbar">
    <md-icon-button id="backBtn" class="hidden" title="Indietro"><span class="material-symbols-outlined">arrow_back</span></md-icon-button>
    <div class="title">Ricette <span class="dot">NLP</span></div>
  </header>

  <main>
    <!-- SEARCH VIEW -->
    <section id="searchView">
      <div class="searchbar">
        <!-- Campo di ricerca NLP -->
        <md-outlined-text-field
          id="q"
          label="Descrivi cosa vuoi cucinare…"
          placeholder="Es. pasta vegana con broccoli pronta in meno di 30 minuti"
          supporting-text="Ricerca in linguaggio naturale (NLP)"
          class="full"
          style="width:100%"
        >
          <span slot="leading-icon" class="material-symbols-outlined">search</span>
        </md-outlined-text-field>
        <md-filled-button id="searchBtn" aria-label="Cerca">Cerca</md-filled-button>
      </div>
      
      <!-- Filtri rapidi (aggiungono termini alla query) -->
      <div class="quick-filters" aria-label="Filtri rapidi">
        <md-filter-chip data-token="vegetariano" label="Vegetariano"></md-filter-chip>
        <md-filter-chip data-token="vegano" label="Vegano"></md-filter-chip>
        <md-filter-chip data-token="senza glutine" label="Senza glutine"></md-filter-chip>
        <md-filter-chip data-token="< 30 min" label="≤ 30 min"></md-filter-chip>
        <md-filter-chip data-token="italiana" label="Italiana"></md-filter-chip>
        <md-filter-chip data-token="piccante" label="Piccante"></md-filter-chip>
      </div>

      <!-- Stato caricamento -->
      <div id="loading" class="hidden" style="display:flex;align-items:center;gap:10px;margin-top:14px;">
        <md-circular-progress indeterminate></md-circular-progress>
        <span>Cerco le ricette più pertinenti…</span>
      </div>

      <!-- Risultati -->
      <div id="results" class="results" aria-live="polite"></div>
    </section>

    <!-- DETAIL VIEW -->
    <section id="detailView" class="detail" aria-live="polite"></section>
  </main>

  <script>
    /*************************************************
     * MVP Ricette NLP – Front-end Vanilla JS + M3   *
     * ------------------------------------------------
     * - Ricerca in linguaggio naturale via API REST
     * - Lista risultati ordinati per rilevanza
     * - Pagina dettaglio con tutte le specifiche
     * - UI Material Design (Material Web Components)
     * - Italiano, responsive, commentato
     *************************************************/

    /**
     * CONFIGURAZIONE
     * Imposta l'endpoint del tuo backend NLP.
     * Puoi disattivare DEMO_MODE per usare davvero le API.
     */
    const CONFIG = {
      DEMO_MODE: true, // true = usa dati di esempio; false = chiama la tua API
      API_BASE_URL: "https://api.tuodominio.it", // es.: https://api.mioserver.com
      ENDPOINTS: {
        SEARCH: "/ricette/search",        // GET ?q=...
        DETAIL: "/ricette/",               // GET /:id
      },
    };

    /**
     * MODELLI (tipi informali) – allineati allo schema fornito
     *
     * Recipe {
     *   _id: string
     *   category: string[]
     *   chef_advise: string
     *   cooking_time: number (minuti)
     *   cuisine_type: string
     *   description: string
     *   diet: string
     *   embedding: number[]
     *   ingredients: { name: string, qt: number, um: string }[]
     *   language: string
     *   nutritional_info: string[]
     *   preparation_time: number (minuti)
     *   recipe_step: string[]
     *   ricetta_audio: string (URL)
     *   ricetta_caption: string
     *   shortcode: string
     *   tags: string[]
     *   technique: string
     *   title: string
     *   score?: number  // opzionale, attinenza della ricerca [0..1]
     * }
     */

    /**
     * API Client minimale – incapsula le chiamate HTTP.
     * In DEMO_MODE ritorna dati fittizi.
     */
    const Api = {
      /** Ricerca ricette via NLP */
      async search(q) {
        if (CONFIG.DEMO_MODE) return Demo.search(q);
        const url = `${CONFIG.API_BASE_URL}${CONFIG.ENDPOINTS.SEARCH}?q=${encodeURIComponent(q)}`;
        const res = await fetch(url, { headers: { "Accept": "application/json" } });
        if (!res.ok) throw new Error("Errore risposta API search");
        return res.json(); // atteso: Recipe[] con (opz.) score
      },
      /** Dettaglio ricetta */
      async getById(id) {
        if (CONFIG.DEMO_MODE) return Demo.getById(id);
        const url = `${CONFIG.API_BASE_URL}${CONFIG.ENDPOINTS.DETAIL}${encodeURIComponent(id)}`;
        const res = await fetch(url, { headers: { "Accept": "application/json" } });
        if (!res.ok) throw new Error("Errore risposta API dettaglio");
        return res.json(); // atteso: Recipe
      }
    };

    /**
     * DATI DI ESEMPIO – coprono lo schema e permettono test immediati.
     */
    const Demo = (() => {
      /** helper */
      const id = (n) => `demo-${n}`;
      const common = {
        language: "it",
        nutritional_info: ["Calorie: 420 kcal/porzione", "Proteine: 18 g", "Carboidrati: 55 g", "Grassi: 12 g"],
      };
      /** tre ricette di esempio */
      const RECIPES = [
        {
          _id: id(1),
          category: ["Primo"],
          chef_advise: "Usa tuorli a temperatura ambiente per una crema più setosa.",
          cooking_time: 10,
          cuisine_type: "Italiana",
          description: "Classica pasta alla Carbonara cremosa senza panna.",
          diet: "onnivoro",
          embedding: [0.12, 0.04, -0.11, 0.33],
          ingredients: [
            { name: "Spaghetti", qt: 320, um: "g" },
            { name: "Guanciale", qt: 120, um: "g" },
            { name: "Tuorli", qt: 6, um: "pz" },
            { name: "Pecorino romano", qt: 80, um: "g" },
            { name: "Pepe nero", qt: 2, um: "g" },
            { name: "Sale", qt: 1, um: "q.b." },
          ],
          language: "it",
          nutritional_info: common.nutritional_info,
          preparation_time: 5,
          recipe_step: [
            "Rosola il guanciale a fiamma media finché croccante.",
            "Sbatti i tuorli con pecorino e pepe.",
            "Cuoci la pasta al dente, conserva acqua di cottura.",
            "Manteca fuori dal fuoco con crema d'uovo, poca acqua e guanciale.",
          ],
          ricetta_audio: "https://cdn.example.com/audio/carbonara.mp3",
          ricetta_caption: "Pasta alla Carbonara – versione tradizionale romana",
          shortcode: "CARBO",
          tags: ["classico", "cremoso"],
          technique: "Mantecatura",
          title: "Pasta alla Carbonara",
          score: 0.91,
        },
        {
          _id: id(2),
          category: ["Primo"],
          chef_advise: "Tosta bene il riso e sfuma generosamente per un risotto cremoso.",
          cooking_time: 18,
          cuisine_type: "Italiana",
          description: "Risotto ai funghi porcini, cremoso e profumato.",
          diet: "vegetariano",
          embedding: [0.08, -0.01, 0.15, 0.29],
          ingredients: [
            { name: "Riso Carnaroli", qt: 320, um: "g" },
            { name: "Porcini", qt: 200, um: "g" },
            { name: "Brodo vegetale", qt: 1, um: "l" },
            { name: "Burro", qt: 40, um: "g" },
            { name: "Parmigiano", qt: 50, um: "g" },
            { name: "Scalogno", qt: 1, um: "pz" },
          ],
          language: "it",
          nutritional_info: ["Calorie: 380 kcal/porzione", "Proteine: 10 g", "Carboidrati: 60 g", "Grassi: 9 g"],
          preparation_time: 10,
          recipe_step: [
            "Soffriggi lo scalogno tritato.",
            "Tosta il riso, sfuma con vino bianco.",
            "Aggiungi brodo poco alla volta e i funghi.",
            "Manteca con burro e parmigiano.",
          ],
          ricetta_audio: "https://cdn.example.com/audio/risotto.mp3",
          ricetta_caption: "Risotto ai funghi – comfort food autunnale",
          shortcode: "RIS-FUN",
          tags: ["senza glutine", "cremoso"],
          technique: "Risottatura",
          title: "Risotto ai funghi",
          score: 0.84,
        },
        {
          _id: id(3),
          category: ["Primo"],
          chef_advise: "Aggiungi l'acqua di cottura a filo per emulsionare l'olio.",
          cooking_time: 8,
          cuisine_type: "Italiana",
          description: "Spaghetti aglio, olio e peperoncino: semplici e veloci.",
          diet: "vegano",
          embedding: [0.02, 0.22, -0.02, 0.11],
          ingredients: [
            { name: "Spaghetti", qt: 320, um: "g" },
            { name: "Aglio", qt: 3, um: "spicchi" },
            { name: "Olio EVO", qt: 60, um: "ml" },
            { name: "Peperoncino", qt: 1, um: "pz" },
            { name: "Prezzemolo", qt: 1, um: "ciuffo" },
            { name: "Sale", qt: 1, um: "q.b." },
          ],
          language: "it",
          nutritional_info: ["Calorie: 360 kcal/porzione", "Proteine: 9 g", "Carboidrati: 62 g", "Grassi: 9 g"],
          preparation_time: 5,
          recipe_step: [
            "Soffriggi aglio e peperoncino nell'olio.",
            "Cuoci gli spaghetti e scolali al dente.",
            "Salta in padella emulsionando con acqua di cottura.",
            "Completa con prezzemolo tritato.",
          ],
          ricetta_audio: "https://cdn.example.com/audio/aglioolio.mp3",
          ricetta_caption: "Aglio, olio e peperoncino – salvacena veloce",
          shortcode: "AOP",
          tags: ["veloce", "economico"],
          technique: "Saltare",
          title: "Spaghetti aglio e olio",
          score: 0.78,
        },
      ];

      // full-text naive search per la demo
      function rankByQuery(q) {
        const terms = q.toLowerCase().split(/\s+/).filter(Boolean);
        return RECIPES.map(r => {
          let s = r.score ?? 0.5;
          const hay = (
            r.title + " " + r.description + " " + r.diet + " " + r.cuisine_type + " " + r.tags.join(" ")
          ).toLowerCase();
          for (const t of terms) if (hay.includes(t)) s += 0.05;
          return { ...r, score: Math.min(1, Number(s.toFixed(2))) };
        }).sort((a,b) => b.score - a.score);
      }

      return {
        async search(q) { await sleep(450); return rankByQuery(q || ""); },
        async getById(id) { await sleep(250); return RECIPES.find(r => r._id === id); },
      };
    })();

    // Utility: delay
    function sleep(ms) { return new Promise(r => setTimeout(r, ms)); }

    // Stato semplice dell'app
    const state = {
      results: [],
      lastQuery: "",
      current: null,
    };

    // Riferimenti DOM
    const $ = sel => document.querySelector(sel);
    const resultsEl = $("#results");
    const loadingEl = $("#loading");
    const detailView = $("#detailView");
    const searchView = $("#searchView");
    const qInput = $("#q");
    const backBtn = $("#backBtn");

    // Inizializzazione router hash – #/ricetta/:id oppure root
    window.addEventListener("hashchange", onRouteChange);
    window.addEventListener("DOMContentLoaded", () => {
      attachEvents();
      onRouteChange(); // prima render
    });

    /** Gestisce il cambio rotta in base all'hash */
    async function onRouteChange() {
      const id = parseRecipeIdFromHash();
      if (id) {
        // Mostra dettaglio
        backBtn.classList.remove("hidden");
        searchView.style.display = "none";
        detailView.classList.add("active");
        renderDetailSkeleton();
        try {
          const recipe = await Api.getById(id);
          if (!recipe) throw new Error("Ricetta non trovata");
          state.current = recipe;
          renderDetail(recipe);
        } catch (err) {
          renderError(detailView, err);
        }
      } else {
        // Mostra ricerca
        backBtn.classList.add("hidden");
        detailView.classList.remove("active");
        searchView.style.display = "block";
        if (!state.results.length) {
          // UI "vuota": suggerisci query
          renderEmptyState();
        }
      }
    }

    function parseRecipeIdFromHash() {
      const m = location.hash.match(/^#\/ricetta\/(.+)$/);
      return m ? decodeURIComponent(m[1]) : null;
    }

    /** Event binding */
    function attachEvents() {
      $("#searchBtn").addEventListener("click", () => doSearch(qInput.value));
      qInput.addEventListener("keydown", (e) => {
        if (e.key === "Enter") doSearch(qInput.value);
      });
      document.querySelectorAll("md-filter-chip[data-token]").forEach(chip => {
        chip.addEventListener("click", () => {
          const token = chip.getAttribute("data-token");
          const val = qInput.value.trim();
          qInput.value = val ? `${val} ${token}` : token;
          qInput.focus();
        });
      });
      backBtn.addEventListener("click", () => { location.hash = ""; });
    }

    /** Esegue la ricerca e renderizza i risultati */
    async function doSearch(q) {
      const query = (q || "").trim();
      state.lastQuery = query;
      resultsEl.innerHTML = "";
      loadingEl.classList.remove("hidden");
      try {
        const results = await Api.search(query);
        state.results = Array.isArray(results) ? results : [];
        renderResults(state.results);
      } catch (err) {
        renderError(resultsEl, err);
      } finally {
        loadingEl.classList.add("hidden");
      }
    }

    /** Render – stato vuoto iniziale */
    function renderEmptyState() {
      resultsEl.innerHTML = `
        <div class="section" style="text-align:center">
          <h3>Trova ricette con la ricerca in linguaggio naturale</h3>
          <p class="muted">Esempi: "dolce vegano senza glutine", "pasta pronta in 20 minuti", "cena piccante con ceci"</p>
        </div>
      `;
    }

    /** Render – lista risultati */
    function renderResults(list) {
      if (!list.length) {
        resultsEl.innerHTML = `<div class="section">Nessun risultato trovato per <strong>${escapeHtml(state.lastQuery)}</strong>.</div>`;
        return;
      }
      const frag = document.createDocumentFragment();
      list.forEach(r => frag.appendChild(renderResultCard(r)));
      resultsEl.innerHTML = "";
      resultsEl.appendChild(frag);
    }

    /** Crea una card risultato (elemento cliccabile) */
    function renderResultCard(r) {
      const el = document.createElement("article");
      el.className = "card";
      el.setAttribute("role", "button");
      el.setAttribute("aria-label", `Apri ${r.title}`);
      el.innerHTML = `
        <div class="title">${escapeHtml(r.title)}</div>
        <div class="meta">
          <span class="chip"><span class="material-symbols-outlined">timer</span>&nbsp;Prep ${r.preparation_time} min · Cott ${r.cooking_time} min</span>
          <span class="chip">${escapeHtml(r.cuisine_type)}</span>
          <span class="chip">${escapeHtml(r.diet)}</span>
          ${(r.tags||[]).slice(0,2).map(t=>`<span class="chip">${escapeHtml(t)}</span>`).join("")}
          <span class="score" title="Attendibilità"><span class="material-symbols-outlined">verified</span>${formatScore(r.score)}</span>
        </div>
        <div class="muted">${escapeHtml((r.description||"").slice(0,140))}${r.description && r.description.length>140?"…":""}</div>
      `;
      el.addEventListener("click", () => { location.hash = `#/ricetta/${encodeURIComponent(r._id)}`; });
      return el;
    }

    /** Format score [0,1] -> es. 91% */
    function formatScore(s) {
      if (typeof s !== "number") return "";
      return Math.round(s * 100) + "%";
    }

    /** Render – scheletro mentre carica il dettaglio */
    function renderDetailSkeleton() {
      detailView.innerHTML = `
        <div class="back-row">
          <md-icon-button title="Indietro"><span class="material-symbols-outlined">arrow_back</span></md-icon-button>
          <div class="muted">Caricamento ricetta…</div>
        </div>
        <md-linear-progress indeterminate></md-linear-progress>
      `;
      detailView.querySelector("md-icon-button")?.addEventListener("click", () => history.back());
    }

    /** Render – pagina dettaglio */
    function renderDetail(r) {
      detailView.innerHTML = `
        <div class="back-row">
          <md-icon-button title="Indietro"><span class="material-symbols-outlined">arrow_back</span></md-icon-button>
          <h2 style="margin:0">${escapeHtml(r.title)}</h2>
        </div>

        <div class="grid-2">
          <div class="section">
            <h3>Descrizione</h3>
            <p>${escapeHtml(r.description || "")}</p>
            <div class="chips" style="margin-top:8px">
              ${chip("Categoria", (r.category||[]).join(", "))}
              ${chip("Cucina", r.cuisine_type)}
              ${chip("Dieta", r.diet)}
              ${chip("Tecnica", r.technique)}
              ${(r.tags||[]).map(t=>chip("Tag", t)).join("")}
            </div>
          </div>

          <div class="section">
            <h3>Tempi</h3>
            <p><span class="material-symbols-outlined">schedule</span> Preparazione: <strong>${r.preparation_time} min</strong></p>
            <p><span class="material-symbols-outlined">timer</span> Cottura: <strong>${r.cooking_time} min</strong></p>
            ${typeof r.score === 'number' ? `<p class="muted"><span class="material-symbols-outlined">verified</span> Attendibilità: <strong>${formatScore(r.score)}</strong></p>` : ''}
          </div>
        </div>

        <div class="grid-2">
          <div class="section">
            <h3>Ingredienti</h3>
            <ul class="ingredients">
              ${(r.ingredients||[]).map(it => `<li>${escapeHtml(it.name)} — <strong>${formatQty(it.qt)} ${escapeHtml(it.um)}</strong></li>`).join("")}
            </ul>
          </div>
          <div class="section">
            <h3>Procedimento</h3>
            <ol class="steps">${(r.recipe_step||[]).map(s => `<li>${escapeHtml(s)}</li>`).join("")}</ol>
          </div>
        </div>

        <div class="grid-2">
          <div class="section">
            <h3>Consiglio dello chef</h3>
            <p>${escapeHtml(r.chef_advise || "-")}</p>
          </div>
          <div class="section">
            <h3>Informazioni nutrizionali</h3>
            <ul>${(r.nutritional_info||[]).map(s => `<li>${escapeHtml(s)}</li>`).join("")}</ul>
          </div>
        </div>

        <div class="grid-2">
          <div class="section">
            <h3>Ascolta la ricetta</h3>
            ${r.ricetta_audio ? `<audio controls src="${escapeAttr(r.ricetta_audio)}" style="width:100%"></audio>` : '<p class="muted">Audio non disponibile</p>'}
            ${r.ricetta_caption ? `<p class="muted" style="margin-top:6px">${escapeHtml(r.ricetta_caption)}</p>` : ''}
          </div>
          <div class="section">
            <h3>Condivisione</h3>
            <p>Shortcode: <code>${escapeHtml(r.shortcode || r._id)}</code></p>
            <md-outlined-button id="shareBtn"><span class="material-symbols-outlined">share</span>&nbsp;Copia link</md-outlined-button>
          </div>
        </div>
      `;
      // Bind pulsanti
      detailView.querySelector("md-icon-button")?.addEventListener("click", () => history.back());
      detailView.querySelector("#shareBtn")?.addEventListener("click", () => copyLink(r._id));
    }

    /** Helpers di rendering */
    function chip(label, value) {
      if (!value) return "";
      return `<span class="chip" title="${escapeAttr(label)}">${escapeHtml(value)}</span>`;
    }
    function formatQty(q) { return (typeof q === 'number' && Number.isFinite(q)) ? (Number.isInteger(q) ? q : q.toLocaleString('it-IT')) : q; }
    function escapeHtml(s="") { return s.replace(/[&<>\"]/g, c => ({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;"}[c])); }
    function escapeAttr(s="") { return escapeHtml(String(s)).replace(/'/g, "&#39;"); }

    async function copyLink(id) {
      const url = `${location.origin}${location.pathname}#/ricetta/${encodeURIComponent(id)}`;
      try { await navigator.clipboard.writeText(url); alert("Link copiato negli appunti!\n" + url); }
      catch { prompt("Copia manualmente il link:", url); }
    }
  </script>
</body>
</html>
