<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Embeddings 3D Preview</title>
    <script src="https://cdn.plot.ly/plotly-2.30.0.min.js"></script>
    <style>
      html, body { height: 100%; margin: 0; }
      #plot { width: 100%; height: 100%; }
      #toolbar { position: absolute; top: 8px; left: 8px; z-index: 10; background: rgba(255,255,255,0.85); padding: 6px 8px; border-radius: 6px; font-family: sans-serif; font-size: 14px; }
      #toolbar input { width: 80px; }
    </style>
  </head>
  <body>
    <div id="toolbar">
      <form id="controls" onsubmit="return false;" style="display:flex; gap:8px; align-items:center;">
        <label>Limite:
          <input id="limit" type="number" value="1000" min="10" max="10000" step="10" />
        </label>
        <button id="reload" type="button">Ricarica</button>
        <span style="border-left:1px solid #ccc; height:18px; margin:0 6px;"></span>
        <label>Query:
          <input id="query" type="text" placeholder="es. pasta al pomodoro" size="28" />
        </label>
        <button id="plotQuery" type="button">Visualizza query</button>
      </form>
    </div>
    <div id="plot"></div>
    <script>
    async function loadAndPlot(limit){
      const res = await fetch(`/embeddings/preview3d?limit=${encodeURIComponent(limit)}&with_meta=1`);
      const data = await res.json();
      if(data.status !== 'ok' || !data.points || !data.points.length){
        document.getElementById('plot').innerHTML = 'Nessun dato disponibile';
        return;
      }
      const xs = data.points.map(p => p.x);
      const ys = data.points.map(p => p.y);
      const zs = data.points.map(p => p.z);
      const texts = data.points.map(p => (p.label || p.id));
      const trace = {
        type: 'scatter3d',
        mode: 'markers',
        name: 'dataset',
        x: xs, y: ys, z: zs,
        text: texts,
        marker: { size: 3, opacity: 0.85 }
      };
      const layout = {
        title: `Embeddings (PCA 3D) — ${data.n} punti`,
        scene: {xaxis:{title:'PC1'}, yaxis:{title:'PC2'}, zaxis:{title:'PC3'}},
        margin: {l:0, r:0, t:40, b:0}
      };
      Plotly.newPlot('plot', [trace], layout, {responsive: true});
    }
    async function loadWithQuery(limit, query){
      const res = await fetch(`/embeddings/preview3d_with_query?q=${encodeURIComponent(query)}&limit=${encodeURIComponent(limit)}&with_meta=1`);
      const data = await res.json();
      if(data.status !== 'ok' || !data.points || !data.points.length){
        document.getElementById('plot').innerHTML = 'Nessun dato disponibile';
        return;
      }
      const xs = data.points.map(p => p.x);
      const ys = data.points.map(p => p.y);
      const zs = data.points.map(p => p.z);
      const texts = data.points.map(p => (p.label || p.id));
      const traceDataset = {
        type: 'scatter3d',
        mode: 'markers',
        name: 'dataset',
        x: xs, y: ys, z: zs,
        text: texts,
        marker: { size: 3, opacity: 0.8 }
      };
      const qp = data.query_point;
      const traceQuery = qp ? {
        type: 'scatter3d',
        mode: 'markers+text',
        name: 'query',
        x: [qp.x], y: [qp.y], z: [qp.z],
        text: [qp.label],
        textposition: 'top center',
        marker: { size: 6, color: 'red', opacity: 1 }
      } : null;
      const layout = {
        title: `Embeddings (PCA 3D) — ${data.n} punti + query`,
        scene: {xaxis:{title:'PC1'}, yaxis:{title:'PC2'}, zaxis:{title:'PC3'}},
        margin: {l:0, r:0, t:40, b:0}
      };
      const traces = traceQuery ? [traceDataset, traceQuery] : [traceDataset];
      Plotly.newPlot('plot', traces, layout, {responsive: true});
    }
    document.getElementById('reload').addEventListener('click', () => {
      const limit = parseInt(document.getElementById('limit').value || '1000', 10);
      loadAndPlot(limit);
    });
    document.getElementById('plotQuery').addEventListener('click', () => {
      const limit = parseInt(document.getElementById('limit').value || '1000', 10);
      const q = (document.getElementById('query').value || '').trim();
      if(!q){
        loadAndPlot(limit);
      } else {
        loadWithQuery(limit, q);
      }
    });
    loadAndPlot(1000);
    </script>
  </body>
  </html>
